openapi: 3.0.3
info:
  title: Mirage API
  description: |
    Build social apps with just `fetch()`. Mirage handles authentication,
    encryption, and syncing across devices automatically.
    
    **No backend required** - data syncs via decentralized relays.
  version: 1.0.0
  contact:
    name: Mirage
  license:
    name: MIT

servers:
  - url: /mirage/v1
    description: API base URL

tags:
  - name: System
    description: Check if the API is ready to use
  - name: Feed
    description: Read and post public messages (like tweets)
  - name: Users
    description: Get user profiles and display names
  - name: Storage
    description: |
      Save and load app data (settings, drafts, preferences).
      Data syncs across all your devices automatically.
  - name: Spaces
    description: |
      Shared workspaces for collaboration. Data is encrypted and synced
      between members. Use the `store` endpoint for easy shared state.
  - name: DirectMessages
    description: |
      Private one-on-one messages. Fully encrypted - only you and the
      recipient can read them.
  - name: Contacts
    description: |
      Manage your social graph (following list). Add or remove friends
      and see who other users are following.


paths:
  /ready:
    get:
      tags: [System]
      summary: Check if API is ready
      description: |
        Returns status information. Check this endpoint once at startup
        to ensure the system is online before making API calls.
        
        **Usage:**
        ```javascript
        const status = await fetch('/mirage/v1/ready').then(r => r.json());
        if (status.ready) {
          // Start using API
        }
        ```
      operationId: getReady
      responses:
        '200':
          description: System is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                    description: Always true when endpoint responds
                  authenticated:
                    type: boolean
                    description: Whether the user has signed in
                  relayCount:
                    type: integer
                    description: Number of active network connections

  /events:
    get:
      tags: [System]
      summary: Query events
      description: |
        Low-level query interface for raw Nostr events.
        Use this to fetch specific kinds of data (notes, profiles, etc).

        **Common Queries:**
        - **Feed:** `kinds=[1]`
        - **Profiles:** `kinds=[0], authors=[pk]`
      operationId: getEvents
      parameters:
        - name: kinds
          in: query
          description: Event kinds to filter by (e.g. 1 for notes)
          schema:
            type: array
            items:
              type: integer
        - name: authors
          in: query
          description: Public keys of authors to filter by
          schema:
            type: array
            items:
              type: string
        - name: since
          in: query
          description: Only return events newer than this timestamp
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                   $ref: '#/components/schemas/NostrEvent'
              example:
                - id: "4376c..."
                  kind: 1
                  content: "Hello Nostr!"
                  pubkey: "abc..."
                  created_at: 1678886400
                  tags: []

    post:
      tags: [System]
      summary: Publish raw event
      description: |
        Publish a raw Nostr event. The system will sign it and broadcast to relays.
        Useful for custom event kinds not covered by helper endpoints.
      operationId: publishEvent
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content, kind]
              properties:
                kind:
                  type: integer
                  description: Event kind (e.g. 1 for note)
                content:
                  type: string
                  description: Event content
                tags:
                  type: array
                  items:
                    type: array
                    items:
                      type: string
      responses:
        '201':
          description: Event published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NostrEvent'

  /profiles/{pubkey}:
    get:
      tags: [Users]
      summary: Get user profile
      description: |
        Fetch a user's profile metadata (Kind 0).
        This includes name, bio, avatar, and other NIP-01 fields.
      operationId: getProfile
      parameters:
        - name: pubkey
          in: path
          required: true
          description: Hex public key or npub
          schema:
            type: string
            example: "39fe47...a6835c2f"
      responses:
        '200':
          description: User profile found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileContent'
              example:
                name: "Alice"
                about: "Crypto enthusiast"
                picture: "https://example.com/alice.jpg"
                nip05: "alice@example.com"

  /contacts:
    get:
      tags: [Contacts]
      summary: Get my contacts
      description: Returns the list of people you follow (Kind 3).
      operationId: getContacts
      security:
        - nip07: []
      responses:
        '200':
          description: Your contact list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contact'
        '404':
          description: No contact list found
    
    put:
      tags: [Contacts]
      summary: Update contact list
      description: |
        Replace your entire contact list.
        To add a user, fetch the current list, append the new user, and PUT the result.
      operationId: updateContacts
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [contacts]
              properties:
                contacts:
                  type: array
                  items:
                    $ref: '#/components/schemas/Contact'
      responses:
        '200':
          description: Contact list updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: 
                    type: boolean

  /contacts/{pubkey}:
    get:
      tags: [Contacts]
      summary: Get user's contacts
      description: See who another user is following.
      operationId: getUserContacts
      parameters:
        - name: pubkey
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User's contact list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contact'


  /storage/{key}:
    get:
      tags: [Storage]
      summary: Get stored value
      description: |
        Retrieves a previously stored value by key. Data is automatically
        synced across all devices.
        
        **Common Use Cases:**
        - App settings and preferences
        - Draft content (e.g., unsaved posts)
        - User-specific configuration
        
        **Security Notes:**
        - Requires `storage_read` permission
        - Data is stored on a public network (encrypt sensitive data client-side)
        - Scoped per user (only your data is accessible)
      operationId: getStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key (alphanumeric, dashes, underscores)
          schema:
            type: string
            example: "settings"
      responses:
        '200':
          description: Stored value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated (no signer available)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Storage]
      summary: Store a value
      description: |
        Stores or updates a value by key. Changes are signed by you and
        propagated to the network.
        
        **Common Use Cases:**
        - Save app settings: `{"theme": "dark", "fontSize": 16}`
        - Store drafts: `{"content": "Work in progress..."}`
        - Sync preferences across devices
        
        **Security Notes:**
        - Requires `storage_write` permission
        - You sign the data (it cannot be forged)
        - Replaces previous value with same key
      operationId: putStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key
          schema:
            type: string
            example: "settings"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: Any JSON value to store
              example: {"theme": "dark", "notifications": true}
      responses:
        '200':
          description: Value stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [Storage]
      summary: Delete a stored value
      description: |
        Deletes a stored value.
        Note: Data is removed from your view, but due to the decentralized
        nature of the network, some replicas might persist briefly.
      operationId: deleteStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key to delete
          schema:
            type: string
            example: "obsolete-setting"
      responses:
        '200':
          description: Value deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  key:
                    type: string
                    example: "obsolete-setting"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===========================================================================
  # Spaces
  # ===========================================================================

  /spaces:
    get:
      tags: [Spaces]
      summary: List my spaces
      description: Returns all spaces you're a member of.
      operationId: listSpaces
      security:
        - nip07: []
      responses:
        '200':
          description: Your spaces
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Space'

    post:
      tags: [Spaces]
      summary: Create a space
      description: |
        Start a new shared space. You'll be the owner.
        Invite others using the invite endpoint.
      operationId: createSpace
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Name for the space (e.g., "Family Groceries")
                  example: "Family Space"
      responses:
        '201':
          description: Space created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Space'

  /spaces/{spaceId}:
    get:
      tags: [Spaces]
      summary: Get space details
      operationId: getSpace
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Space details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Space'

  /spaces/{spaceId}/store:
    get:
      tags: [Spaces]
      summary: Get shared data (Shared KV)
      description: |
        Get the current state of the shared database.
        Returns a JSON object where each key is the latest value.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/spaces/{id}/store');
        es.onmessage = (event) => {
          const { key, value } = JSON.parse(event.data);
          // Update state[key] = value
        };
        ```
      operationId: getSpaceStore
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Current state
          content:
            application/json:
              schema:
                type: object
                description: Key-Value map of current state
                example: {"milk": true, "eggs": false}
            text/event-stream:
              schema:
                $ref: '#/components/schemas/StoreUpdate'

  /spaces/{spaceId}/store/{key}:
    put:
      tags: [Spaces]
      summary: Update shared data
      description: |
        Update a single key in the shared database.
        Uses "Last-Write-Wins" logic.
      operationId: putSpaceStore
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
        - name: key
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: Any JSON value
              example: true
      responses:
        '200':
          description: Updated

  /spaces/{spaceId}/messages:
    get:
      tags: [Spaces]
      summary: Get raw messages
      description: |
        Get raw event log from the space. Useful for chat apps or custom logic.
      operationId: getSpaceMessages
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
        - name: since
          in: query
          description: Unix timestamp
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SpaceMessage'

    post:
      tags: [Spaces]
      summary: Send a raw message
      operationId: sendSpaceMessage
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpaceMessage'

  /library/apps:
    get:
      tags: [System]
      summary: List my applications
      description: Returns all Mirage applications you've published or added to your library.
      operationId: listLibraryApps
      security:
        - nip07: []
      responses:
        '200':
          description: Your applications
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AppDefinition'

    post:
      tags: [System]
      summary: Add app to library
      description: Save an application to your personal library.
      operationId: addLibraryApp
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AppDefinition'
      responses:
        '201':
          description: App added
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

    delete:
      tags: [System]
      summary: Remove app from library
      description: Deletes an application from your library.
      operationId: deleteLibraryApp
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [naddr]
              properties:
                naddr:
                  type: string
                  description: The unique identifier (naddr) of the app
      responses:
        '200':
          description: App removed
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: string

  /spaces/all:
    get:
      tags: [Spaces]
      summary: List all spaces
      description: Returns all spaces across all applications, including invitations.
      operationId: listAllSpaces
      security:
        - nip07: []
      responses:
        '200':
          description: All spaces
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Space'

  /spaces/{spaceId}:
    get:
      tags: [Spaces]
      summary: Get space details
      operationId: getSpace
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Space details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Space'

  /spaces/{spaceId}/invite:
    post:
      tags: [Spaces]
      summary: Invite someone to the space
      description: |
        Add a person to your space. They'll receive an invitation.
      operationId: inviteToSpace
      security:
        - nip07: []
      parameters:
        - name: spaceId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pubkey]
              properties:
                pubkey:
                  type: string
                  description: The user's ID (their public key)
      responses:
        '200':
          description: Invitation sent

  # ===========================================================================
  # Direct Messages (NIP-17)
  # ===========================================================================

  /dm:
    get:
      tags: [DirectMessages]
      summary: List your conversations
      description: See everyone you've messaged privately.
      operationId: listConversations
      security:
        - nip07: []
      responses:
        '200':
          description: Your private conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'

  /dm/{pubkey}:
    get:
      tags: [DirectMessages]
      summary: Get messages with someone
      description: |
        Get your private conversation with a specific person. Supports real-time streaming.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/dm/{pubkey}');
        es.onmessage = (event) => console.log(JSON.parse(event.data));
        ```
      operationId: getDirectMessages
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          description: The other person's ID
          schema:
            type: string
        - name: since
          in: query
          description: Only return messages newer than this time
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DirectMessage'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/EventStream'

    post:
      tags: [DirectMessages]
      summary: Send a private message
      description: Send an encrypted message to someone. Only they can read it.
      operationId: sendDirectMessage
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectMessage'

components:
  securitySchemes:
    nip07:
      type: apiKey
      in: header
      name: X-User-Auth
      description: |
        Automatic browser authentication. The Mirage environment handles
        user identity and signing securely. Apps don't need to implement this.

  schemas:
    # =========================================================================
    # Nostr Core Schemas
    # =========================================================================

    NostrEvent:
      type: object
      required: [id, pubkey, created_at, kind, content, tags]
      properties:
        id:
          type: string
          description: 32-byte hex ID
        pubkey: 
          type: string
          description: Author's public key
        created_at:
          type: integer
          description: Unix timestamp
        kind:
          type: integer
          description: Event kind (0=Metadata, 1=Text, 3=Contacts, etc)
        tags:
          type: array
          items:
            type: array
            items:
              type: string
        content:
          type: string
          description: Payload string (JSON for kind 0/3, text for kind 1)
        sig:
          type: string
          description: Schnorr signature

    ProfileContent:
      type: object
      description: Parsed content of a Kind 0 Metadata event
      properties:
        name:
          type: string
          description: Short username
        display_name:
          type: string
          description: Full display name
        about:
          type: string
          description: Bio / Description
        picture:
          type: string
          format: uri
          description: Avatar URL
        banner:
          type: string
          format: uri
          description: Banner image URL
        website:
          type: string
          format: uri
        nip05:
          type: string
          description: NIP-05 Verification ID (user@domain.com)
        lud16:
          type: string
          description: Lightning Address (user@domain.com)

    # =========================================================================
    # App Storage (NIP-78)
    # =========================================================================

    StorageValue:
      type: object
      description: Stored app data (settings, preferences, etc.)
      required: [key, value, updatedAt]
      properties:
        key:
          type: string
          description: Name of the setting or data item
          example: "settings"
        value:
          description: The stored value (any JSON type)
          example: {"theme": "dark", "notifications": true}
        updatedAt:
          type: integer
          description: Unix timestamp of last update
          example: 1703203200

    # =========================================================================
    # Streaming
    # =========================================================================

    EventStream:
      type: string
      description: |
        Server-Sent Events (SSE) stream.
        Each message starts with `data: ` and ends with `\n\n`.
      example: |
        data: {"id":"123", "content":"Hello"}

        data: {"id":"124", "content":"World"}

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code (optional)
          example: "AUTH_REQUIRED"

    # =========================================================================
    # Spaces
    # =========================================================================

    Space:
      type: object
      description: A shared encrypted workspace
      properties:
        id:
          type: string
          description: Space identifier
        name:
          type: string
          description: Space display name
        createdAt:
          type: integer
          description: Unix timestamp
        memberCount:
          type: integer
          description: Number of members

    SpaceMessage:
      type: object
      description: A message in a space (regular or system)
      required: [id, spaceId, author, content, type, createdAt]
      properties:
        id:
          type: string
          description: Unique event identifier
        spaceId:
          type: string
          description: ID of the space
        author:
          type: string
          description: Sender's public key
        content:
          type: string
          description: |
            For regular messages: the decrypted message text.
            For system messages: JSON-encoded SystemEvent.
        type:
          type: string
          enum: [message, system]
          description: |
            - `message`: Regular user message
            - `system`: System notification (member joined, left, etc.)
        createdAt:
          type: integer
          description: Unix timestamp

    StoreUpdate:
      type: object
      description: Real-time update for the Shared KV Store
      required: [key, value]
      properties:
        key:
          type: string
          description: The key that changed
        value:
          description: The new JSON value

    SystemEvent:
      type: object
      description: Payload for system messages (parsed from content when type=system)
      required: [action]
      properties:
        action:
          type: string
          enum: [member_joined, space_created, space_renamed]
          description: Type of system event
        pubkey:
          type: string
          description: Affected member's public key
        invitedBy:
          type: string
          description: Who invited the member
        name:
          type: string
          description: Space name
        createdBy:
          type: string
          description: Who created the space
        oldName:
          type: string
          description: Previous name
        newName:
          type: string
          description: New name

    SpaceMember:
      type: object
      properties:
        pubkey:
          type: string
        name:
          type: string
          description: Display name if known
        joinedAt:
          type: integer

    # =========================================================================
    # Direct Messages
    # =========================================================================

    Conversation:
      type: object
      properties:
        pubkey:
          type: string
          description: Other party's pubkey
        name:
          type: string
          description: Display name if known
        lastMessage:
          type: string
          description: Preview of last message
        lastMessageAt:
          type: integer
        unreadCount:
          type: integer

    DirectMessage:
      type: object
      properties:
        id:
          type: string
        from:
          type: string
        to:
          type: string
        content:
          type: string
          description: Decrypted message content
        createdAt:
          type: integer

    # =========================================================================
    # Contacts
    # =========================================================================

    Contact:
      type: object
      required: [pubkey]
      properties:
        pubkey:
          type: string
          description: Public key of the contact
        relay:
          type: string
          description: Recommended relay URL for this contact (optional)
        petname:
          type: string
          description: Local nickname for this contact (optional)

    AppDefinition:
      type: object
      description: Metadata for a Mirage application
      required: [naddr, name, createdAt]
      properties:
        naddr:
          type: string
          description: Bech32 address for the application (NIP-19)
          example: "naddr1..."
        name:
          type: string
          description: Custom name for the application
          example: "My Awesome App"
        createdAt:
          type: integer
          description: Unix timestamp of when the app was added/published
          example: 1703635200
