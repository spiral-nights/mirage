<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mirage Contacts Demo (NIP-02)</title>
    <style>
        :root {
            --bg: #111;
            --fg: #eee;
            --accent: #d2aaff;
            --secondary: #222;
            --border: #333;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--fg);
            margin: 0;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: var(--secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            overflow-y: auto;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }

        h2,
        h3 {
            margin-top: 0;
            color: var(--accent);
        }

        input,
        button {
            background: #000;
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        button {
            cursor: pointer;
            background: var(--border);
            font-weight: bold;
        }

        button:hover {
            background: #444;
        }

        .row {
            display: flex;
            gap: 0.5rem;
        }

        .contact-card {
            background: #000;
            border: 1px solid var(--border);
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pubkey {
            font-family: monospace;
            font-size: 0.8rem;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }

        .petname {
            font-weight: bold;
            color: var(--accent);
        }

        .danger {
            color: #ff6b6b;
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .success {
            color: #51cf66;
            border-color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
        }

        #inspect-results {
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
    </style>
</head>

<body>

    <!-- SIDEBAR: MY CONTACTS -->
    <div class="sidebar">
        <h2>My Contacts</h2>
        <div id="status">Connecting...</div>

        <div
            style="margin-top: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-bottom: 1rem;">
            <h3>Add Contact</h3>
            <input type="text" id="add-pubkey" placeholder="Pubkey (hex or npub)"
                style="width: 100%; box-sizing: border-box;">
            <input type="text" id="add-petname" placeholder="Petname (Nickname)"
                style="width: 100%; box-sizing: border-box;">
            <button onclick="addContact()" style="width: 100%;">Follow User</button>
        </div>

        <div id="my-contacts-list">
            <!-- Loaded via JS -->
        </div>
    </div>

    <!-- MAIN: INSPECT OTHERS -->
    <div class="main">
        <h2>Inspect Social Graph</h2>
        <p>Enter a pubkey to see who they follow.</p>

        <div class="row">
            <input type="text" id="inspect-pubkey" placeholder="Target Pubkey (hex or npub)" style="flex: 1;">
            <button onclick="inspectUser()">Inspect</button>
        </div>

        <div id="inspect-results">
            <!-- Results go here -->
        </div>
    </div>

    <script type="module">
        import { initBridge } from '../packages/core/dist/bridge.js';

        // Global State
        let myContacts = [];
        let myPubkey = '';

        // Expose functions to window for HTML buttons
        window.addContact = addContact;
        window.removeContact = removeContact;
        window.inspectUser = inspectUser;

        async function init() {
            try {
                // Persistent Key
                let key = localStorage.getItem('contacts_demo_key');
                if (!key) {
                    const bytes = new Uint8Array(32);
                    crypto.getRandomValues(bytes);
                    key = Array.from(bytes, b => b.toString(16).padStart(2, '0')).join('');
                    localStorage.setItem('contacts_demo_key', key);
                }
                myPubkey = key;

                await initBridge({
                    workerUrl: '../packages/core/dist/engine.js',
                    relays: ['wss://relay.damus.io', 'wss://nos.lol'],
                    privateKey: key
                });

                document.getElementById('status').innerText = 'Connected as ' + key.slice(0, 8) + '...';
                loadMyContacts();

            } catch (e) {
                console.error(e);
                document.getElementById('status').innerText = 'Error: ' + e.message;
            }
        }

        // Cache for profiles
        const profileCache = new Map();

        async function fetchProfiles(pubkeys) {
            if (pubkeys.length === 0) return;

            // Filter out known ones to save bandwidth
            const missing = pubkeys.filter(k => !profileCache.has(k));
            if (missing.length === 0) return;

            // Batch fetch (limit to ~20 at a time to keep URL length safe, or use POST if available)
            // Mirage GET /events supports multiple authors.
            // Let's do a simple chunking
            const chunkSize = 20;
            for (let i = 0; i < missing.length; i += chunkSize) {
                const chunk = missing.slice(i, i + chunkSize);
                try {
                    const params = new URLSearchParams();
                    params.append('kinds', '0');
                    chunk.forEach(k => params.append('authors', k));

                    const res = await fetch(`/mirage/v1/events?${params.toString()}`);
                    const events = await res.json();

                    events.forEach(e => {
                        try {
                            const content = JSON.parse(e.content);
                            profileCache.set(e.pubkey, content.name || content.display_name || content.nip05 || '');
                        } catch { }
                    });
                } catch (e) {
                    console.error('Profile fetch failed', e);
                }
            }
        }

        function getDisplayName(pubkey, petname) {
            if (petname) return petname; // Petname takes precedence
            if (profileCache.has(pubkey)) return profileCache.get(pubkey);
            return 'No Name'; // Fallback
        }

        async function loadMyContacts() {
            try {
                const res = await fetch('/mirage/v1/contacts');
                myContacts = await res.json();

                // Fetch profiles for better UX
                const pubkeys = myContacts.map(c => c.pubkey);
                await fetchProfiles(pubkeys);

                renderMyContacts();
            } catch (e) {
                console.error('Failed to load contacts', e);
            }
        }

        function renderMyContacts() {
            const list = document.getElementById('my-contacts-list');
            list.innerHTML = '';

            if (myContacts.length === 0) {
                list.innerHTML = '<div style="padding:10px; color:#666">No contacts found.</div>';
                return;
            }

            myContacts.forEach(c => {
                const name = getDisplayName(c.pubkey, c.petname);
                const el = document.createElement('div');
                el.className = 'contact-card';
                el.innerHTML = `
                    <div class="contact-info">
                        <span class="petname">${name}</span>
                        <span class="pubkey" title="${c.pubkey}">${c.pubkey.slice(0, 10)}...</span>
                        <small style="font-size: 0.7rem; color: #666;">${c.relay || ''}</small>
                    </div>
                     <button class="danger" style="margin-left: 10px;" onclick="removeContact('${c.pubkey}')">X</button>
                `;
                list.appendChild(el);
            });
        }

        async function addContact() {
            const pubkeyInput = document.getElementById('add-pubkey');
            const petnameInput = document.getElementById('add-petname');
            const pubkey = pubkeyInput.value.trim();
            const petname = petnameInput.value.trim();

            if (!pubkey) return alert('Pubkey required');

            // Optimistic Update
            myContacts.push({ pubkey, petname });
            renderMyContacts();

            // Save
            await fetch('/mirage/v1/contacts', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contacts: myContacts })
            });

            pubkeyInput.value = '';
            petnameInput.value = '';
            // Background refresh
            loadMyContacts();
        }

        async function removeContact(pubkey) {
            if (!confirm('Unfollow user?')) return;

            myContacts = myContacts.filter(c => c.pubkey !== pubkey);
            renderMyContacts();

            await fetch('/mirage/v1/contacts', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contacts: myContacts })
            });

            loadMyContacts();
        }

        async function inspectUser() {
            const input = document.getElementById('inspect-pubkey');
            const target = input.value.trim();
            if (!target) return;

            const div = document.getElementById('inspect-results');
            div.innerHTML = 'Loading...';

            try {
                const res = await fetch(`/mirage/v1/contacts/${target}`);

                if (res.status === 404) {
                    div.innerHTML = 'User has no contacts list (Kind 3).';
                    return;
                }

                const contacts = await res.json();

                div.innerHTML = 'Fetching profiles...';

                // Fetch profiles
                const pubkeys = contacts.map(c => c.pubkey);
                await fetchProfiles(pubkeys);

                div.innerHTML = '';
                if (contacts.length === 0) {
                    div.innerHTML = 'User follows no one.';
                    return;
                }

                contacts.forEach(c => {
                    const name = getDisplayName(c.pubkey, c.petname);
                    const el = document.createElement('div');
                    el.className = 'contact-card';
                    el.innerHTML = `
                        <div class="contact-info">
                            <span class="petname">${name}</span>
                            <span class="pubkey">${c.pubkey}</span>
                        </div>
                    `;
                    div.appendChild(el);
                });

            } catch (e) {
                div.innerHTML = 'Error fetching contacts: ' + e.message;
            }
        }

        init();
    </script>
</body>

</html>