openapi: 3.0.3
info:
  title: Mirage API
  description: |
    Build social apps with just `fetch()`. Mirage handles authentication,
    encryption, and syncing across devices automatically.
    
    **No backend required** - data syncs via decentralized relays.
  version: 1.0.0
  contact:
    name: Mirage
  license:
    name: MIT

servers:
  - url: /mirage/v1
    description: API base URL

tags:
  - name: System
    description: Check if the API is ready to use
  - name: Feed
    description: Read and post public messages (like tweets)
  - name: Users
    description: Get user profiles and display names
  - name: Storage
    description: |
      Save and load app data (settings, drafts, preferences).
      Data syncs across all your devices automatically.
  - name: Channels
    description: |
      Private group chats. Messages are encrypted so only members can read them.
      Invite family or friends, and the app handles all the security.
  - name: DirectMessages
    description: |
      Private one-on-one messages. Fully encrypted - only you and the
      recipient can read them.


paths:
  /ready:
    get:
      tags: [System]
      summary: Check if API is ready
      description: |
        Returns status information. Check this endpoint once at startup
        to ensure the system is online before making API calls.
        
        **Usage:**
        ```javascript
        const status = await fetch('/mirage/v1/ready').then(r => r.json());
        if (status.ready) {
          // Start using API
        }
        ```
      operationId: getReady
      responses:
        '200':
          description: System is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                    description: Always true when endpoint responds
                  authenticated:
                    type: boolean
                    description: Whether the user has signed in
                  relayCount:
                    type: integer
                    description: Number of active network connections

  /feed:
    get:
      tags: [Feed]
      summary: Get recent posts
      description: Returns a list of the latest public posts from your network.
      operationId: getFeed
      parameters:
        - name: limit
          in: query
          description: Maximum number of notes to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of notes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
            text/event-stream:
              schema:
                type: string
                description: |
                  Stream of new events. Format: `data: {JSON}\n\n`.
                  Connection stays open and pushes new posts as they appear.

    post:
      tags: [Feed]
      summary: Create a post
      description: |
        Publish a new public message to your followers.
        The system handles signing and distribution automatically.
      operationId: postFeed
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  description: Note content
                  example: "Hello Nostr!"
                tags:
                  type: array
                  description: Optional event tags
                  items:
                    type: array
                    items:
                      type: string
                  example: [["t", "nostr"], ["p", "pubkey..."]]
      responses:
        '201':
          description: Note published successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Event'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/me:
    get:
      tags: [Users]
      summary: Get my profile
      description: |
        Get profile details for the currently signed-in user.
      operationId: getCurrentUser
      security:
        - nip07: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetadataContent'
        '401':
          description: No signer available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{pubkey}:
    get:
      tags: [Users]
      summary: Get user profile
      description: Get profile details for any user by their ID (public key).
      operationId: getUserByPubkey
      parameters:
        - name: pubkey
          in: path
          required: true
          description: User's public key (64-character hex)
          schema:
            type: string
            pattern: '^[a-f0-9]{64}$'
            example: "82341f882b6eabcd2ba7f1ef90aad961cf074af15b9ef44a09f9d2a8fbfbe6a2"
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetadataContent'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /storage/{key}:
    get:
      tags: [Storage]
      summary: Get stored value
      description: |
        Retrieves a previously stored value by key. Data is automatically
        synced across all devices.
        
        **Common Use Cases:**
        - App settings and preferences
        - Draft content (e.g., unsaved posts)
        - User-specific configuration
        
        **Security Notes:**
        - Requires `storage_read` permission
        - Data is stored on a public network (encrypt sensitive data client-side)
        - Scoped per user (only your data is accessible)
      operationId: getStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key (alphanumeric, dashes, underscores)
          schema:
            type: string
            example: "settings"
      responses:
        '200':
          description: Stored value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated (no signer available)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Storage]
      summary: Store a value
      description: |
        Stores or updates a value by key. Changes are signed by you and
        propagated to the network.
        
        **Common Use Cases:**
        - Save app settings: `{"theme": "dark", "fontSize": 16}`
        - Store drafts: `{"content": "Work in progress..."}`
        - Sync preferences across devices
        
        **Security Notes:**
        - Requires `storage_write` permission
        - You sign the data (it cannot be forged)
        - Replaces previous value with same key
      operationId: putStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key
          schema:
            type: string
            example: "settings"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: Any JSON value to store
              example: {"theme": "dark", "notifications": true}
      responses:
        '200':
          description: Value stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [Storage]
      summary: Delete a stored value
      description: |
        Deletes a stored value.
        Note: Data is removed from your view, but due to the decentralized
        nature of the network, some replicas might persist briefly.
      operationId: deleteStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key to delete
          schema:
            type: string
            example: "obsolete-setting"
      responses:
        '200':
          description: Value deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  key:
                    type: string
                    example: "obsolete-setting"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===========================================================================
  # Channels (Phase 3)
  # ===========================================================================

  /channels:
    get:
      tags: [Channels]
      summary: List my group chats
      description: Returns all private group chats you're a member of.
      operationId: listChannels
      security:
        - nip07: []
      responses:
        '200':
          description: Your group chats
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Channel'

    post:
      tags: [Channels]
      summary: Create a group chat
      description: |
        Start a new private group chat. You'll be the first member.
        Invite others using the invite endpoint.
      operationId: createChannel
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Name for the group (e.g., "Family", "Book Club")
                  example: "Family Chat"
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Channel'

  /channels/{channelId}:
    get:
      tags: [Channels]
      summary: Get channel details
      operationId: getChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Channel details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Channel'

  /channels/{channelId}/messages:
    get:
      tags: [Channels]
      summary: Get messages
      description: |
        Get messages from the group chat. Supports real-time streaming.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/channels/{id}/messages');
        es.onmessage = (event) => console.log(JSON.parse(event.data));
        ```
        
        **One-time fetch:** Use `limit` param to get recent messages.
      operationId: getChannelMessages
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
        - name: since
          in: query
          description: Only return messages newer than this time (seconds since 1970)
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChannelMessage'
            text/event-stream:
              schema:
                type: string
                description: |
                  Real-time stream of new messages.
                  Format: `data: {JSON}\n\n`.
                  Or use `new EventSource('/channels/{id}/messages')`.

    post:
      tags: [Channels]
      summary: Send a message
      operationId: sendChannelMessage
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelMessage'

  /channels/{channelId}/members:
    get:
      tags: [Channels]
      summary: List channel members
      operationId: getChannelMembers
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChannelMember'

  /channels/{channelId}/invite:
    post:
      tags: [Channels]
      summary: Invite someone to the group
      description: |
        Add a person to your private group chat. They'll receive an
        invitation and be able to see all future messages.
      operationId: inviteToChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pubkey]
              properties:
                pubkey:
                  type: string
                  description: The user's ID (their public key)
      responses:
        '200':
          description: Invitation sent

  /channels/{channelId}/remove:
    post:
      tags: [Channels]
      summary: Remove someone from the group
      description: |
        Kick a person out of the group chat. They won't be able to
        read any new messages after this.
      operationId: removeFromChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pubkey]
              properties:
                pubkey:
                  type: string
      responses:
        '200':
          description: User removed, key rotated

  /channels/{channelId}/leave:
    post:
      tags: [Channels]
      summary: Leave the group
      description: Remove yourself from the group chat.
      operationId: leaveChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Left channel

  # ===========================================================================
  # Direct Messages (Phase 4)
  # ===========================================================================

  /dm:
    get:
      tags: [DirectMessages]
      summary: List your conversations
      description: See everyone you've messaged privately.
      operationId: listConversations
      security:
        - nip07: []
      responses:
        '200':
          description: Your private conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'

  /dm/{pubkey}:
    get:
      tags: [DirectMessages]
      summary: Get messages with someone
      description: |
        Get your private conversation with a specific person. Supports real-time streaming.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/dm/{pubkey}');
        es.onmessage = (event) => console.log(JSON.parse(event.data));
        ```
      operationId: getDirectMessages
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          description: The other person's ID
          schema:
            type: string
        - name: since
          in: query
          description: Only return messages newer than this time
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DirectMessage'
            text/event-stream:
              schema:
                type: string
                description: |
                  Real-time stream of new messages.
                  Format: `data: {JSON}\n\n`.
                  Or use `new EventSource('/dm/{pubkey}')`.

    post:
      tags: [DirectMessages]
      summary: Send a private message
      description: Send an encrypted message to someone. Only they can read it.
      operationId: sendDirectMessage
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectMessage'

components:
  securitySchemes:
    nip07:
      type: apiKey
      in: header
      name: X-User-Auth
      description: |
        Automatic browser authentication. The Mirage environment handles
        user identity and signing securely. Apps don't need to implement this.

  schemas:
    Event:
      type: object
      description: |
        A single data object on the network. Most commonly used for
        short text posts (like tweets), but can represent any type of data.
      required: [id, pubkey, created_at, content, kind, tags]
      properties:
        id:
          type: string
          description: Unique ID of the event (32-byte hex)
        pubkey:
          type: string
          description: Author's user ID (public key)
        created_at:
          type: integer
          description: Unix timestamp (seconds)
        kind:
          type: integer
          description: |
            The type of data this event represents.
            
            **Common Types:**
            - `0`: **Metadata** (User profile: name, about, picture)
            - `1`: **Short Text Note** (Like a tweet or status update)
            - `3`: **Contacts** (List of follows)
            - `6`: **Repost** (Sharing another event)
            - `7`: **Reaction** (Like/Upvote - content is usually "+" or emoji)
            - `30023`: **Long Form Article** (Blog post)
            - `30078`: **App Data** (Private storage)
            - `10002`: **Relay List** (Network connections)
          example: 1
        content:
          type: string
          description: |
            The main data payload.
            - For `kind: 1` (Note): The text content
            - For `kind: 7` (Reaction): "+" or an emoji
            - For `kind: 0` (Metadata): A JSON string matching `MetadataContent` schema
        tags:
          type: array
          description: |
            Metadata tags associated with the event.
            Each tag is an array of strings: `["identifier", "value", ...]`
            
            **Common Tags:**
            - `["e", "event_id"]`: Reference to another event (Reply/Quote)
            - `["p", "pubkey"]`: Tagging a user (Mention)
            - `["t", "hashtag"]`: Topic tag (Hashtag)
            - `["r", "url"]`: Reference to a URL
            - `["title", "My Blog Post"]`: Title for long-form content
          items:
            type: array
            items:
              type: string
          example:
            - ["e", "4376c..."]
            - ["p", "82341..."]
            - ["t", "nostr"]
        sig:
          type: string
          description: Cryptographic signature proving authorship

    MetadataContent:
      type: object
      description: |
        Profile metadata structure (Kind 0 content).
        Standardized fields for user profiles.
      properties:
        name:
          type: string
          description: Username or handle (e.g. "satoshi")
        display_name:
          type: string
          description: Fancy display name (e.g. "Satoshi Nakamoto")
        about:
          type: string
          description: Bio or description
        picture:
          type: string
          format: uri
          description: Avatar URL
        banner:
          type: string
          format: uri
          description: Profile header image URL
        website:
          type: string
          format: uri
          description: Website URL
        nip05:
          type: string
          description: Verified web address (e.g. user@domain.com)
        lud16:
          type: string
          description: Lightning Network address (e.g. satoshi@getalby.com)

    StorageValue:
      type: object
      description: Stored app data (settings, preferences, etc.)
      required: [key, value, updatedAt]
      properties:
        key:
          type: string
          description: Name of the setting or data item
          example: "settings"
        value:
          description: The stored value (any JSON type)
          example: {"theme": "dark", "notifications": true}
        updatedAt:
          type: integer
          description: Unix timestamp of last update
          example: 1703203200

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Error message
          example: "Relay pool not initialized"

    # =========================================================================
    # Phase 3: Encrypted Channels
    # =========================================================================

    Channel:
      type: object
      description: An encrypted group channel
      properties:
        id:
          type: string
          description: Channel identifier
        name:
          type: string
          description: Channel display name
        createdAt:
          type: integer
          description: Unix timestamp
        memberCount:
          type: integer
          description: Number of members
        keyVersion:
          type: integer
          description: Current encryption key version

    ChannelMessage:
      type: object
      description: A message in a channel (regular or system)
      properties:
        id:
          type: string
        type:
          type: string
          enum: [message, system]
          description: Regular message or system event
        from:
          type: string
          description: Sender pubkey (for messages)
        content:
          type: string
          description: Decrypted message content
        event:
          type: string
          description: System event type (member_added, member_removed, etc.)
        member:
          type: string
          description: Affected member pubkey (for system events)
        by:
          type: string
          description: Actor pubkey (for system events)
        createdAt:
          type: integer

    ChannelMember:
      type: object
      properties:
        pubkey:
          type: string
        name:
          type: string
          description: Display name if known
        joinedAt:
          type: integer

    # =========================================================================
    # Phase 4: Direct Messages
    # =========================================================================

    Conversation:
      type: object
      properties:
        pubkey:
          type: string
          description: Other party's pubkey
        name:
          type: string
          description: Display name if known
        lastMessage:
          type: string
          description: Preview of last message
        lastMessageAt:
          type: integer
        unreadCount:
          type: integer

    DirectMessage:
      type: object
      properties:
        id:
          type: string
        from:
          type: string
        to:
          type: string
        content:
          type: string
          description: Decrypted message content
        createdAt:
          type: integer
