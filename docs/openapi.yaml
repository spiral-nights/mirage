openapi: 3.0.3
info:
  title: Mirage Virtual API
  description: |
    The Mirage Virtual API provides a REST-like interface for Nostr interactions.
    These endpoints are intercepted by the Mirage Bridge and processed by the
    Web Worker engine - no actual HTTP requests leave the browser.
  version: 1.0.0
  contact:
    name: Mirage
  license:
    name: MIT

servers:
  - url: /mirage/v1
    description: Virtual API (intercepted by Bridge)

tags:
  - name: Feed
    description: Public notes (Kind 1 events)
  - name: Users
    description: User profiles (Kind 0 events)
  - name: Storage
    description: |
      Persistent key-value storage using NIP-78 (Kind 30078 events).
      Data is signed by the user and stored on Nostr relays.
      Keys are scoped per app to prevent collisions.

paths:
  /feed:
    get:
      tags: [Feed]
      summary: Get recent notes
      description: Fetches recent Kind 1 notes from connected Nostr relays
      operationId: getFeed
      parameters:
        - name: limit
          in: query
          description: Maximum number of notes to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        '200':
          description: List of notes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NostrEvent'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    post:
      tags: [Feed]
      summary: Publish a note
      description: |
        Creates and publishes a Kind 1 note. Requires NIP-07 signer.
        The event will be signed via the host's signer integration.
      operationId: postFeed
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  description: Note content
                  example: "Hello Nostr!"
                tags:
                  type: array
                  description: Optional event tags
                  items:
                    type: array
                    items:
                      type: string
                  example: [["t", "nostr"], ["p", "pubkey..."]]
      responses:
        '201':
          description: Note published successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NostrEvent'
        '400':
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /user/me:
    get:
      tags: [Users]
      summary: Get current user profile
      description: |
        Fetches the Kind 0 profile for the currently signed-in user.
        Requires NIP-07 signer to be available.
      operationId: getCurrentUser
      security:
        - nip07: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: No signer available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{pubkey}:
    get:
      tags: [Users]
      summary: Get user by public key
      description: Fetches the Kind 0 profile for a specific user
      operationId: getUserByPubkey
      parameters:
        - name: pubkey
          in: path
          required: true
          description: User's public key (64-character hex)
          schema:
            type: string
            pattern: '^[a-f0-9]{64}$'
            example: "82341f882b6eabcd2ba7f1ef90aad961cf074af15b9ef44a09f9d2a8fbfbe6a2"
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '404':
          description: Profile not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /storage/{key}:
    get:
      tags: [Storage]
      summary: Get stored value
      description: |
        Retrieves a previously stored value by key. Data is fetched from
        Nostr relays as Kind 30078 events.
        
        **Common Use Cases:**
        - App settings and preferences
        - Draft content (e.g., unsaved posts)
        - User-specific configuration
        
        **Security Notes:**
        - Requires `storage_read` permission
        - Data is public on relays (encrypt sensitive data client-side)
        - Scoped per user (only your data is accessible)
      operationId: getStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key (alphanumeric, dashes, underscores)
          schema:
            type: string
            example: "settings"
      responses:
        '200':
          description: Stored value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated (no signer available)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Storage]
      summary: Store a value
      description: |
        Stores or updates a value by key. Creates a signed Kind 30078 event
        that is published to connected relays.
        
        **Common Use Cases:**
        - Save app settings: `{"theme": "dark", "fontSize": 16}`
        - Store drafts: `{"content": "Work in progress..."}`
        - Sync preferences across devices
        
        **Security Notes:**
        - Requires `storage_write` permission
        - User signs the event (cannot be forged)
        - Replaces previous value with same key
      operationId: putStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key
          schema:
            type: string
            example: "settings"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: Any JSON value to store
              example: {"theme": "dark", "notifications": true}
      responses:
        '200':
          description: Value stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [Storage]
      summary: Delete a stored value
      description: |
        Deletes a stored value by publishing an empty replacement event.
        Note: On Nostr, data cannot be truly deleted from all relays,
        but this marks the key as deleted for Mirage clients.
      operationId: deleteStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key to delete
          schema:
            type: string
            example: "obsolete-setting"
      responses:
        '200':
          description: Value deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  key:
                    type: string
                    example: "obsolete-setting"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    nip07:
      type: apiKey
      in: header
      name: X-NIP-07
      description: |
        NIP-07 browser extension signing. The Mirage Host automatically
        handles signing requests - apps don't need to manage this directly.

  schemas:
    NostrEvent:
      type: object
      required: [id, pubkey, created_at, kind, tags, content, sig]
      properties:
        id:
          type: string
          description: Event ID (32-byte hex)
          example: "4376c65d2f232afbe9b882a35baa4f6fe8667c4e684749af565f981833ed6a65"
        pubkey:
          type: string
          description: Author's public key (32-byte hex)
          example: "82341f882b6eabcd2ba7f1ef90aad961cf074af15b9ef44a09f9d2a8fbfbe6a2"
        created_at:
          type: integer
          description: Unix timestamp
          example: 1703203200
        kind:
          type: integer
          description: Event kind (1 = note, 0 = profile)
          example: 1
        tags:
          type: array
          items:
            type: array
            items:
              type: string
          example: [["p", "pubkey..."], ["e", "event-id..."]]
        content:
          type: string
          description: Event content
          example: "Hello Nostr!"
        sig:
          type: string
          description: Schnorr signature (64-byte hex)
          example: "908a15e46fb4d8675bab026fc230a0e3542bfade63da02d542fb78b2a8513fcd..."

    UserProfile:
      type: object
      properties:
        pubkey:
          type: string
          description: User's public key
        name:
          type: string
          description: Display name
          example: "satoshi"
        about:
          type: string
          description: Bio/description
          example: "Creator of Bitcoin"
        picture:
          type: string
          format: uri
          description: Profile picture URL
          example: "https://example.com/avatar.jpg"
        nip05:
          type: string
          description: NIP-05 identifier
          example: "satoshi@bitcoin.org"
        lud16:
          type: string
          description: Lightning address
          example: "satoshi@getalby.com"

    StorageValue:
      type: object
      description: A stored key-value pair from NIP-78 application data
      required: [key, value, updatedAt]
      properties:
        key:
          type: string
          description: The storage key
          example: "settings"
        value:
          description: The stored value (any JSON type)
          example: {"theme": "dark", "notifications": true}
        updatedAt:
          type: integer
          description: Unix timestamp of last update
          example: 1703203200

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Error message
          example: "Relay pool not initialized"
