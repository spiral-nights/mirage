openapi: 3.0.3
info:
  title: Mirage API
  description: |
    Build social apps with just `fetch()`. Mirage handles authentication,
    encryption, and syncing across devices automatically.
    
    **No backend required** - data syncs via decentralized relays.
  version: 1.0.0
  contact:
    name: Mirage
  license:
    name: MIT

servers:
  - url: /mirage/v1
    description: API base URL

tags:
  - name: System
    description: Check if the API is ready to use
  - name: Feed
    description: Read and post public messages (like tweets)
  - name: Users
    description: Get user profiles and display names
  - name: Storage
    description: |
      Save and load app data (settings, drafts, preferences).
      Data syncs across all your devices automatically.
  - name: Channels
    description: |
      Private group chats. Messages are encrypted so only members can read them.
      Invite family or friends, and the app handles all the security.
  - name: DirectMessages
    description: |
      Private one-on-one messages. Fully encrypted - only you and the
      recipient can read them.
  - name: Contacts
    description: |
      Manage your social graph (following list). Add or remove friends
      and see who other users are following.


paths:
  /ready:
    get:
      tags: [System]
      summary: Check if API is ready
      description: |
        Returns status information. Check this endpoint once at startup
        to ensure the system is online before making API calls.
        
        **Usage:**
        ```javascript
        const status = await fetch('/mirage/v1/ready').then(r => r.json());
        if (status.ready) {
          // Start using API
        }
        ```
      operationId: getReady
      responses:
        '200':
          description: System is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  ready:
                    type: boolean
                    description: Always true when endpoint responds
                  authenticated:
                    type: boolean
                    description: Whether the user has signed in
                  relayCount:
                    type: integer
                    description: Number of active network connections

  /events:
    get:
      tags: [System]
      summary: Query events
      description: |
        Low-level query interface for raw Nostr events.
        Use this to fetch specific kinds of data (notes, profiles, etc).

        **Common Queries:**
        - **Feed:** `kinds=[1]`
        - **Profiles:** `kinds=[0], authors=[pk]`
      operationId: getEvents
      parameters:
        - name: kinds
          in: query
          description: Event kinds to filter by (e.g. 1 for notes)
          schema:
            type: array
            items:
              type: integer
        - name: authors
          in: query
          description: Public keys of authors to filter by
          schema:
            type: array
            items:
              type: string
        - name: since
          in: query
          description: Only return events newer than this timestamp
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                   $ref: '#/components/schemas/NostrEvent'
              example:
                - id: "4376c..."
                  kind: 1
                  content: "Hello Nostr!"
                  pubkey: "abc..."
                  created_at: 1678886400
                  tags: []

    post:
      tags: [System]
      summary: Publish raw event
      description: |
        Publish a raw Nostr event. The system will sign it and broadcast to relays.
        Useful for custom event kinds not covered by helper endpoints.
      operationId: publishEvent
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content, kind]
              properties:
                kind:
                  type: integer
                  description: Event kind (e.g. 1 for note)
                content:
                  type: string
                  description: Event content
                tags:
                  type: array
                  items:
                    type: array
                    items:
                      type: string
      responses:
        '201':
          description: Event published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NostrEvent'

  /profiles/{pubkey}:
    get:
      tags: [Users]
      summary: Get user profile
      description: |
        Fetch a user's profile metadata (Kind 0).
        This includes name, bio, avatar, and other NIP-01 fields.
      operationId: getProfile
      parameters:
        - name: pubkey
          in: path
          required: true
          description: Hex public key or npub
          schema:
            type: string
            example: "39fe47...a6835c2f"
      responses:
        '200':
          description: User profile found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileContent'
              example:
                name: "Alice"
                about: "Crypto enthusiast"
                picture: "https://example.com/alice.jpg"
                nip05: "alice@example.com"

  /contacts:
    get:
      tags: [Contacts]
      summary: Get my contacts
      description: Returns the list of people you follow (Kind 3).
      operationId: getContacts
      security:
        - nip07: []
      responses:
        '200':
          description: Your contact list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contact'
        '404':
          description: No contact list found
    
    put:
      tags: [Contacts]
      summary: Update contact list
      description: |
        Replace your entire contact list.
        To add a user, fetch the current list, append the new user, and PUT the result.
      operationId: updateContacts
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [contacts]
              properties:
                contacts:
                  type: array
                  items:
                    $ref: '#/components/schemas/Contact'
      responses:
        '200':
          description: Contact list updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: 
                    type: boolean

  /contacts/{pubkey}:
    get:
      tags: [Contacts]
      summary: Get user's contacts
      description: See who another user is following.
      operationId: getUserContacts
      parameters:
        - name: pubkey
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: User's contact list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Contact'


  /storage/{key}:
    get:
      tags: [Storage]
      summary: Get stored value
      description: |
        Retrieves a previously stored value by key. Data is automatically
        synced across all devices.
        
        **Common Use Cases:**
        - App settings and preferences
        - Draft content (e.g., unsaved posts)
        - User-specific configuration
        
        **Security Notes:**
        - Requires `storage_read` permission
        - Data is stored on a public network (encrypt sensitive data client-side)
        - Scoped per user (only your data is accessible)
      operationId: getStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key (alphanumeric, dashes, underscores)
          schema:
            type: string
            example: "settings"
      responses:
        '200':
          description: Stored value retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated (no signer available)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Key not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [Storage]
      summary: Store a value
      description: |
        Stores or updates a value by key. Changes are signed by you and
        propagated to the network.
        
        **Common Use Cases:**
        - Save app settings: `{"theme": "dark", "fontSize": 16}`
        - Store drafts: `{"content": "Work in progress..."}`
        - Sync preferences across devices
        
        **Security Notes:**
        - Requires `storage_write` permission
        - You sign the data (it cannot be forged)
        - Replaces previous value with same key
      operationId: putStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key
          schema:
            type: string
            example: "settings"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              description: Any JSON value to store
              example: {"theme": "dark", "notifications": true}
      responses:
        '200':
          description: Value stored successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageValue'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [Storage]
      summary: Delete a stored value
      description: |
        Deletes a stored value.
        Note: Data is removed from your view, but due to the decentralized
        nature of the network, some replicas might persist briefly.
      operationId: deleteStorage
      security:
        - nip07: []
      parameters:
        - name: key
          in: path
          required: true
          description: Storage key to delete
          schema:
            type: string
            example: "obsolete-setting"
      responses:
        '200':
          description: Value deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                    example: true
                  key:
                    type: string
                    example: "obsolete-setting"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Relay pool not initialized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ===========================================================================
  # Channels
  # ===========================================================================

  /channels:
    get:
      tags: [Channels]
      summary: List my group chats
      description: Returns all private group chats you're a member of.
      operationId: listChannels
      security:
        - nip07: []
      responses:
        '200':
          description: Your group chats
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Channel'

    post:
      tags: [Channels]
      summary: Create a group chat
      description: |
        Start a new private group chat. You'll be the first member.
        Invite others using the invite endpoint.
      operationId: createChannel
      security:
        - nip07: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                  description: Name for the group (e.g., "Family", "Book Club")
                  example: "Family Chat"
      responses:
        '201':
          description: Group created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Channel'

  /channels/{channelId}:
    get:
      tags: [Channels]
      summary: Get channel details
      operationId: getChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Channel details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Channel'

  /channels/{channelId}/messages:
    get:
      tags: [Channels]
      summary: Get messages
      description: |
        Get messages from the group chat. Supports real-time streaming.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/channels/{id}/messages');
        es.onmessage = (event) => console.log(JSON.parse(event.data));
        ```
        
        **One-time fetch:** Use `limit` param to get recent messages.
      operationId: getChannelMessages
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
        - name: since
          in: query
          description: Only return messages newer than this time (seconds since 1970)
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChannelMessage'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/EventStream'

    post:
      tags: [Channels]
      summary: Send a message
      operationId: sendChannelMessage
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChannelMessage'

  /channels/{channelId}/members:
    get:
      tags: [Channels]
      summary: List channel members
      operationId: getChannelMembers
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of members
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChannelMember'

  /channels/{channelId}/invite:
    post:
      tags: [Channels]
      summary: Invite someone to the group
      description: |
        Add a person to your private group chat. They'll receive an
        invitation and be able to see all future messages.
      operationId: inviteToChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pubkey]
              properties:
                pubkey:
                  type: string
                  description: The user's ID (their public key)
      responses:
        '200':
          description: Invitation sent

  /channels/{channelId}/remove:
    post:
      tags: [Channels]
      summary: Remove someone from the group
      description: |
        Kick a person out of the group chat. They won't be able to
        read any new messages after this.
      operationId: removeFromChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [pubkey]
              properties:
                pubkey:
                  type: string
      responses:
        '200':
          description: User removed, key rotated

  /channels/{channelId}/leave:
    post:
      tags: [Channels]
      summary: Leave the group
      description: Remove yourself from the group chat.
      operationId: leaveChannel
      security:
        - nip07: []
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Left channel

  # ===========================================================================
  # Direct Messages (NIP-17)
  # ===========================================================================

  /dm:
    get:
      tags: [DirectMessages]
      summary: List your conversations
      description: See everyone you've messaged privately.
      operationId: listConversations
      security:
        - nip07: []
      responses:
        '200':
          description: Your private conversations
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Conversation'

  /dm/{pubkey}:
    get:
      tags: [DirectMessages]
      summary: Get messages with someone
      description: |
        Get your private conversation with a specific person. Supports real-time streaming.
        
        **Streaming (recommended):**
        ```javascript
        const es = new EventSource('/mirage/v1/dm/{pubkey}');
        es.onmessage = (event) => console.log(JSON.parse(event.data));
        ```
      operationId: getDirectMessages
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          description: The other person's ID
          schema:
            type: string
        - name: since
          in: query
          description: Only return messages newer than this time
          schema:
            type: integer
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DirectMessage'
            text/event-stream:
              schema:
                $ref: '#/components/schemas/EventStream'

    post:
      tags: [DirectMessages]
      summary: Send a private message
      description: Send an encrypted message to someone. Only they can read it.
      operationId: sendDirectMessage
      security:
        - nip07: []
      parameters:
        - name: pubkey
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
      responses:
        '201':
          description: Message sent
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectMessage'

components:
  securitySchemes:
    nip07:
      type: apiKey
      in: header
      name: X-User-Auth
      description: |
        Automatic browser authentication. The Mirage environment handles
        user identity and signing securely. Apps don't need to implement this.

  schemas:
    # =========================================================================
    # Nostr Core Schemas
    # =========================================================================

    NostrEvent:
      type: object
      required: [id, pubkey, created_at, kind, content, tags]
      properties:
        id:
          type: string
          description: 32-byte hex ID
        pubkey: 
          type: string
          description: Author's public key
        created_at:
          type: integer
          description: Unix timestamp
        kind:
          type: integer
          description: Event kind (0=Metadata, 1=Text, 3=Contacts, etc)
        tags:
          type: array
          items:
            type: array
            items:
              type: string
        content:
          type: string
          description: Payload string (JSON for kind 0/3, text for kind 1)
        sig:
          type: string
          description: Schnorr signature

    ProfileContent:
      type: object
      description: Parsed content of a Kind 0 Metadata event
      properties:
        name:
          type: string
          description: Short username
        display_name:
          type: string
          description: Full display name
        about:
          type: string
          description: Bio / Description
        picture:
          type: string
          format: uri
          description: Avatar URL
        banner:
          type: string
          format: uri
          description: Banner image URL
        website:
          type: string
          format: uri
        nip05:
          type: string
          description: NIP-05 Verification ID (user@domain.com)
        lud16:
          type: string
          description: Lightning Address (user@domain.com)

    # =========================================================================
    # App Storage (NIP-78)
    # =========================================================================

    StorageValue:
      type: object
      description: Stored app data (settings, preferences, etc.)
      required: [key, value, updatedAt]
      properties:
        key:
          type: string
          description: Name of the setting or data item
          example: "settings"
        value:
          description: The stored value (any JSON type)
          example: {"theme": "dark", "notifications": true}
        updatedAt:
          type: integer
          description: Unix timestamp of last update
          example: 1703203200

    # =========================================================================
    # Streaming
    # =========================================================================

    EventStream:
      type: string
      description: |
        Server-Sent Events (SSE) stream.
        Each message starts with `data: ` and ends with `\n\n`.
      example: |
        data: {"id":"123", "content":"Hello"}

        data: {"id":"124", "content":"World"}

    Error:
      type: object
      required: [error]
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code (optional)
          example: "AUTH_REQUIRED"

    # =========================================================================
    # Encrypted Channels
    # =========================================================================

    Channel:
      type: object
      description: An encrypted group channel
      properties:
        id:
          type: string
          description: Channel identifier
        name:
          type: string
          description: Channel display name
        createdAt:
          type: integer
          description: Unix timestamp
        memberCount:
          type: integer
          description: Number of members
        keyVersion:
          type: integer
          description: Current encryption key version

    ChannelMessage:
      type: object
      description: A message in a channel (regular or system)
      required: [id, channelId, author, content, type, createdAt]
      properties:
        id:
          type: string
          description: Unique event identifier
        channelId:
          type: string
          description: ID of the channel
        author:
          type: string
          description: Sender's public key
        content:
          type: string
          description: |
            For regular messages: the decrypted message text.
            For system messages: JSON-encoded SystemEvent.
        type:
          type: string
          enum: [message, system]
          description: |
            - `message`: Regular user message
            - `system`: System notification (member joined, left, etc.)
        createdAt:
          type: integer
          description: Unix timestamp

    SystemEvent:
      type: object
      description: Payload for system messages (parsed from content when type=system)
      required: [action]
      properties:
        action:
          type: string
          enum: [member_joined, member_left, member_removed, key_rotated, channel_created, channel_renamed]
          description: Type of system event
        pubkey:
          type: string
          description: Affected member's public key (for join/leave/remove)
        invitedBy:
          type: string
          description: Who invited the member (for member_joined)
        removedBy:
          type: string
          description: Who removed the member (for member_removed)
        version:
          type: integer
          description: New key version (for key_rotated)
        name:
          type: string
          description: Channel name (for channel_created)
        createdBy:
          type: string
          description: Who created the channel (for channel_created)
        oldName:
          type: string
          description: Previous name (for channel_renamed)
        newName:
          type: string
          description: New name (for channel_renamed)

    ChannelMember:
      type: object
      properties:
        pubkey:
          type: string
        name:
          type: string
          description: Display name if known
        joinedAt:
          type: integer

    # =========================================================================
    # Direct Messages
    # =========================================================================

    Conversation:
      type: object
      properties:
        pubkey:
          type: string
          description: Other party's pubkey
        name:
          type: string
          description: Display name if known
        lastMessage:
          type: string
          description: Preview of last message
        lastMessageAt:
          type: integer
        unreadCount:
          type: integer

    DirectMessage:
      type: object
      properties:
        id:
          type: string
        from:
          type: string
        to:
          type: string
        content:
          type: string
          description: Decrypted message content
        createdAt:
          type: integer

    # =========================================================================
    # Contacts
    # =========================================================================

    Contact:
      type: object
      required: [pubkey]
      properties:
        pubkey:
          type: string
          description: Public key of the contact
        relay:
          type: string
          description: Recommended relay URL for this contact (optional)
        petname:
          type: string
          description: Local nickname for this contact (optional)
